var t=Object.defineProperty,e=Object.defineProperties,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n,a=(t,e)=>{for(var r in e||(e={}))o.call(e,r)&&i(t,r,e[r]);if(n)for(var r of n(e))s.call(e,r)&&i(t,r,e[r]);return t},c=(t,n)=>e(t,r(n));function f(t,e=/{{(.*?)}}/){let r=e.exec(t);const n=[];let o;for(;r;)o=r.index,0!==o&&(n.push({match:!1,str:t.substring(0,o)}),t=t.slice(o)),n.push({match:!0,str:r[0]}),t=t.slice(r[0].length),r=e.exec(t);return t&&n.push({match:!1,str:t}),n}const u="abcdefghijklmnopqrstuvwxyz",l=new Set(u+u.toUpperCase()+"01234569789()*/+- ");function h(t,e){return f(t).map((t=>{if(!t.match)return t.str;let r=t.str.split(/{{|}}/).filter(Boolean)[0].trim();if(r in e)return e[r];const n=function(t){const e=t.match(/(?<fname>[A-Z_][A-Z_1-9]*)\((?<args>[^)]+)\)/i);if(!(null==e?void 0:e.groups))return;const{fname:r,args:n}=e.groups;return{fname:r,ctx:Object.fromEntries(n.split(",").map((t=>{var e,r;const{key:n,num:o,str:s}=null!=(r=null==(e=t.match(/(?<key>[a-z_0-9]*)\s*=\s*((?<num>[0-9.]+)|('|")(?<str>.*)('|"))/i))?void 0:e.groups)?r:{};if(!n||!o&&!s)throw Error(`Failed to match fn kwarg: ${t}`);return[n,o?Number(o):s]})))}}(r);if(n){const{fname:t,ctx:r}=n,o=e[t];if("function"==typeof o)return o(r);throw Error(`Cannot find function named ${t} in rendering context.`)}const o=function(t){for(let e=0;e<t.length;e++)if(!l.has(t.charAt(e)))return;return f(t,/[A-Za-z_][A-Za-z0-9_]*/gi)}(r);if(o){const t=o.map((t=>{if(!t.match)return t.str;const r=e[t.str];if(null==r)throw Error(`Cannot find number named ${t.str} in rendering context.`);if("number"!=typeof r)throw Error(`The provided value for ${t.str} must be a number.`);return r}));return Function('"use strict";return ('+t.join("")+")")()}throw new Error(`Unable to match ${t.str}`)})).join("")}function p(t,e=h){return"version"in t?function(t,e){var r,n,o,s;const i={};for(const[a,u]of Object.entries(null!=(r=t.templates)?r:{}))u.includes("{{")?i[a]=t=>e(u,t):i[a]=u;const c=(t,r)=>e(t,a(a({},i),r)),f=new Map;for(const[a,u]of Object.entries(null!=(n=t.refs)?n:{}))if("string"==typeof u)f.set(a,u);else{const t=(null==(o=u[0])?void 0:o.includes("{{"))?c(u[0]):u[0];f.set(a,1===u.length?[t]:[t,u[1],u[2]])}for(const a of null!=(s=t.gen)?s:[])for(const t of m(a.dimensions)){const e=c(a.key,t),r=c(a.url,t);if(a.offset&&a.length){const n=c(a.offset,t),o=c(a.length,t);f.set(e,[r,parseInt(n),parseInt(o)])}else f.set(e,[r])}return f}(t,e):function(t){return new Map(Object.entries(t))}(t)}function*m(t){const e=Object.keys(t),r=Object.values(t).map((t=>Array.isArray(t)?t:[...d(t)]));for(const n of function*(...t){if(0===t.length)return;const e=t.map((t=>t[Symbol.iterator]())),r=e.map((t=>t.next()));if(r.some((t=>t.done)))throw new Error("Input contains an empty iterator.");for(let n=0;;){if(r[n].done){if(e[n]=t[n][Symbol.iterator](),r[n]=e[n].next(),++n>=e.length)return}else yield r.map((({value:t})=>t)),n=0;r[n]=e[n].next()}}(...r))yield Object.fromEntries(e.map(((t,e)=>[t,n[e]])))}function*d({stop:t,start:e=0,step:r=1}){for(let n=e;n<t;n+=r)yield n}class y extends Error{constructor(t){var e;super(t),i(this,"symbol"!=typeof(e="__zarr__")?e+"":e,"KeyError"),this.name="KeyError"}}class g{constructor(t,e={}){this.ref=t,this.target=e.target}static fromJSON(t,e={}){const r=p("string"==typeof t?JSON.parse(t):t,e.renderString);return new g(r,e)}_url(t){const[e,r]=t.split("://");if("https"===e||"http"===e)return t;if("gc"===e)return`https://storage.googleapis.com/${r}`;if("s3"===e)return`https://s3.amazonaws.com/${r}`;throw Error("Protocol not supported, got: "+JSON.stringify(e))}_fetch({url:t,offset:e,size:r},n){return void 0!==e&&void 0!==r&&(n=c(a({},n),{headers:c(a({},n.headers),{Range:`bytes=${e}-${e+r-1}`})})),fetch(this._url(t),n)}async getItem(t,e={}){const r=this.ref.get(t);if(!r)throw new y(t);if("string"==typeof r)return r.startsWith("base64:")?b(r.slice(7)).buffer:w.encode(r).buffer;const[n,o,s]=r,i=null!=n?n:this.target;if(!i)throw Error(`No url for key ${t}, and no target url provided.`);const a=await this._fetch({url:i,offset:o,size:s},e);if(200===a.status||206===a.status)return a.arrayBuffer();throw new Error(`Request unsuccessful for key ${t}. Response status: ${a.status}.`)}async containsItem(t){return this.ref.has(t)}async keys(){return[...this.ref.keys()]}setItem(t,e){throw Error("FileReferenceStore.setItem is not implemented.")}deleteItem(t){throw Error("FileReferenceStore.deleteItem is not implemented.")}}const b=(()=>{for(var t=new Uint8Array(128),e=0;e<64;e++)t[e<26?e+65:e<52?e+71:e<62?e-4:4*e-205]=e;return e=>{for(var r=e.length,n=new Uint8Array(3*(r-("="==e[r-1])-("="==e[r-2]))/4|0),o=0,s=0;o<r;){var i=t[e.charCodeAt(o++)],a=t[e.charCodeAt(o++)],c=t[e.charCodeAt(o++)],f=t[e.charCodeAt(o++)];n[s++]=i<<2|a>>4,n[s++]=a<<4|c>>2,n[s++]=c<<6|f}return n}})(),w=new TextEncoder;export{g as ReferenceStore,p as parse};
