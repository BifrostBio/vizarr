var y=Object.defineProperty;var g=(n,r,e)=>r in n?y(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e;var l=(n,r,e)=>(g(n,typeof r!="symbol"?r+"":r,e),e);function m(n,r=/{{(.*?)}}/){let e=r.exec(n);const t=[];let s;for(;e;)s=e.index,s!==0&&(t.push({match:!1,str:n.substring(0,s)}),n=n.slice(s)),t.push({match:!0,str:e[0]}),n=n.slice(e[0].length),e=r.exec(n);return n&&t.push({match:!1,str:n}),t}function w(n){const r=n.match(/(?<fname>[A-Z_][A-Z_1-9]*)\((?<args>[^)]+)\)/i);if(!(r!=null&&r.groups))return;const{fname:e,args:t}=r.groups,s=Object.fromEntries(t.split(",").map(f=>{var a;const{key:c,num:o,str:i}=((a=f.match(/(?<key>[a-z_0-9]*)\s*=\s*((?<num>[0-9.]+)|('|")(?<str>.*)('|"))/i))==null?void 0:a.groups)??{};if(!c||!(o||i))throw Error(`Failed to match fn kwarg: ${f}`);return[c,o?Number(o):i]}));return{fname:e,ctx:s}}const h="abcdefghijklmnopqrstuvwxyz",E="01234569789",b="()*/+-",v=" ",_=new Set(h+h.toUpperCase()+E+b+v);function x(n){for(let r=0;r<n.length;r++)if(!_.has(n.charAt(r)))return;return m(n,/[A-Za-z_][A-Za-z0-9_]*/gi)}function A(n,r){return m(n).map(t=>{if(!t.match)return t.str;let s=t.str.split(/{{|}}/).filter(Boolean)[0].trim();if(s in r)return r[s];const f=w(s);if(f){const{fname:o,ctx:i}=f,a=r[o];if(typeof a=="function")return a(i);throw Error(`Cannot find function named ${o} in rendering context.`)}const c=x(s);if(c){const o=c.map(i=>{if(!i.match)return i.str;const a=r[i.str];if(a==null)throw Error(`Cannot find number named ${i.str} in rendering context.`);if(typeof a!="number")throw Error(`The provided value for ${i.str} must be a number.`);return a});return Function('"use strict";return ('+o.join("")+")")()}throw new Error(`Unable to match ${t.str}`)}).join("")}function $(n,r=A){return"version"in n?O(n,r):k(n)}function k(n){return new Map(Object.entries(n))}function O(n,r){var f;const e={};for(const[c,o]of Object.entries(n.templates??{}))o.includes("{{")?e[c]=i=>r(o,i):e[c]=o;const t=(c,o)=>r(c,{...e,...o}),s=new Map;for(const[c,o]of Object.entries(n.refs??{}))if(typeof o=="string")s.set(c,o);else{const i=(f=o[0])!=null&&f.includes("{{")?t(o[0]):o[0];s.set(c,o.length===1?[i]:[i,o[1],o[2]])}for(const c of n.gen??[])for(const o of I(c.dimensions)){const i=t(c.key,o),a=t(c.url,o);if(c.offset&&c.length){const u=t(c.offset,o),d=t(c.length,o);s.set(i,[a,parseInt(u),parseInt(d)])}else s.set(i,[a])}return s}function*I(n){const r=Object.keys(n),e=Object.values(n).map(t=>Array.isArray(t)?t:[...S(t)]);for(const t of j(...e))yield Object.fromEntries(r.map((s,f)=>[s,t[f]]))}function*j(...n){if(n.length===0)return;const r=n.map(t=>t[Symbol.iterator]()),e=r.map(t=>t.next());if(e.some(t=>t.done))throw new Error("Input contains an empty iterator.");for(let t=0;;){if(e[t].done){if(r[t]=n[t][Symbol.iterator](),e[t]=r[t].next(),++t>=r.length)return}else yield e.map(({value:s})=>s),t=0;e[t]=r[t].next()}}function*S({stop:n,start:r=0,step:e=1}){for(let t=r;t<n;t+=e)yield t}class C extends Error{constructor(e){super(e);l(this,"__zarr__","KeyError");this.name="KeyError"}}class p{constructor(r,e={}){this.ref=r,this.target=e.target}static fromJSON(r,e={}){const t=typeof r=="string"?JSON.parse(r):r,s=$(t,e.renderString);return new p(s,e)}_url(r){const[e,t]=r.split("://");if(e==="https"||e==="http")return r;if(e==="gc")return`https://storage.googleapis.com/${t}`;if(e==="s3")return`https://s3.amazonaws.com/${t}`;throw Error("Protocol not supported, got: "+JSON.stringify(e))}_fetch({url:r,offset:e,size:t},s){return e!==void 0&&t!==void 0&&(s={...s,headers:{...s.headers,Range:`bytes=${e}-${e+t-1}`}}),fetch(this._url(r),s)}async getItem(r,e={}){const t=this.ref.get(r);if(!t)throw new C(r);if(typeof t=="string")return t.startsWith("base64:")?z(t.slice(7)).buffer:N.encode(t).buffer;const[s,f,c]=t,o=s??this.target;if(!o)throw Error(`No url for key ${r}, and no target url provided.`);const i=await this._fetch({url:o,offset:f,size:c},e);if(i.status===200||i.status===206)return i.arrayBuffer();throw new Error(`Request unsuccessful for key ${r}. Response status: ${i.status}.`)}async containsItem(r){return this.ref.has(r)}async keys(){return[...this.ref.keys()]}setItem(r,e){throw Error("FileReferenceStore.setItem is not implemented.")}deleteItem(r){throw Error("FileReferenceStore.deleteItem is not implemented.")}}const z=(()=>{for(var n=new Uint8Array(128),r=0;r<64;r++)n[r<26?r+65:r<52?r+71:r<62?r-4:r*4-205]=r;return e=>{for(var t=e.length,s=new Uint8Array((t-(e[t-1]=="=")-(e[t-2]=="="))*3/4|0),f=0,c=0;f<t;){var o=n[e.charCodeAt(f++)],i=n[e.charCodeAt(f++)],a=n[e.charCodeAt(f++)],u=n[e.charCodeAt(f++)];s[c++]=o<<2|i>>4,s[c++]=i<<4|a>>2,s[c++]=a<<6|u}return s}})(),N=new TextEncoder;export{p as ReferenceStore,$ as parse};
