var E=Object.defineProperty;var b=(n,r,e)=>r in n?E(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e;var m=(n,r,e)=>(b(n,typeof r!="symbol"?r+"":r,e),e);function d(n,r=/{{(.*?)}}/){let e=r.exec(n);const t=[];let s;for(;e;)s=e.index,s!==0&&(t.push({match:!1,str:n.substring(0,s)}),n=n.slice(s)),t.push({match:!0,str:e[0]}),n=n.slice(e[0].length),e=r.exec(n);return n&&t.push({match:!1,str:n}),t}function v(n){const r=n.match(/(?<fname>[A-Z_][A-Z_1-9]*)\((?<args>[^)]+)\)/i);if(!(r!=null&&r.groups))return;const{fname:e,args:t}=r.groups,s=Object.fromEntries(t.split(",").map(f=>{var o,c;const{key:u,num:a,str:i}=(c=(o=f.match(/(?<key>[a-z_0-9]*)\s*=\s*((?<num>[0-9.]+)|('|")(?<str>.*)('|"))/i))==null?void 0:o.groups)!=null?c:{};if(!u||!(a||i))throw Error(`Failed to match fn kwarg: ${f}`);return[u,a?Number(a):i]}));return{fname:e,ctx:s}}const p="abcdefghijklmnopqrstuvwxyz",_="01234569789",x="()*/+-",A=" ",$=new Set(p+p.toUpperCase()+_+x+A);function k(n){for(let r=0;r<n.length;r++)if(!$.has(n.charAt(r)))return;return d(n,/[A-Za-z_][A-Za-z0-9_]*/gi)}function I(n,r){return d(n).map(t=>{if(!t.match)return t.str;let s=t.str.split(/{{|}}/).filter(Boolean)[0].trim();if(s in r)return r[s];const f=v(s);if(f){const{fname:a,ctx:i}=f,o=r[a];if(typeof o=="function")return o(i);throw Error(`Cannot find function named ${a} in rendering context.`)}const u=k(s);if(u){const a=u.map(i=>{if(!i.match)return i.str;const o=r[i.str];if(o==null)throw Error(`Cannot find number named ${i.str} in rendering context.`);if(typeof o!="number")throw Error(`The provided value for ${i.str} must be a number.`);return o});return Function('"use strict";return ('+a.join("")+")")()}throw new Error(`Unable to match ${t.str}`)}).join("")}function O(n,r=I){return"version"in n?S(n,r):j(n)}function j(n){return new Map(Object.entries(n))}function S(n,r){var f,u,a,i;const e={};for(const[o,c]of Object.entries((f=n.templates)!=null?f:{}))c.includes("{{")?e[o]=h=>r(c,h):e[o]=c;const t=(o,c)=>r(o,{...e,...c}),s=new Map;for(const[o,c]of Object.entries((u=n.refs)!=null?u:{}))if(typeof c=="string")s.set(o,c);else{const h=(a=c[0])!=null&&a.includes("{{")?t(c[0]):c[0];s.set(o,c.length===1?[h]:[h,c[1],c[2]])}for(const o of(i=n.gen)!=null?i:[])for(const c of C(o.dimensions)){const h=t(o.key,c),l=t(o.url,c);if(o.offset&&o.length){const g=t(o.offset,c),w=t(o.length,c);s.set(h,[l,parseInt(g),parseInt(w)])}else s.set(h,[l])}return s}function*C(n){const r=Object.keys(n),e=Object.values(n).map(t=>Array.isArray(t)?t:[...F(t)]);for(const t of z(...e))yield Object.fromEntries(r.map((s,f)=>[s,t[f]]))}function*z(...n){if(n.length===0)return;const r=n.map(t=>t[Symbol.iterator]()),e=r.map(t=>t.next());if(e.some(t=>t.done))throw new Error("Input contains an empty iterator.");for(let t=0;;){if(e[t].done){if(r[t]=n[t][Symbol.iterator](),e[t]=r[t].next(),++t>=r.length)return}else yield e.map(({value:s})=>s),t=0;e[t]=r[t].next()}}function*F({stop:n,start:r=0,step:e=1}){for(let t=r;t<n;t+=e)yield t}class R extends Error{constructor(e){super(e);m(this,"__zarr__","KeyError");this.name="KeyError"}}class y{constructor(r,e={}){this.ref=r,this.target=e.target}static fromJSON(r,e={}){const t=typeof r=="string"?JSON.parse(r):r,s=O(t,e.renderString);return new y(s,e)}_url(r){const[e,t]=r.split("://");if(e==="https"||e==="http")return r;if(e==="gc")return`https://storage.googleapis.com/${t}`;if(e==="s3")return`https://s3.amazonaws.com/${t}`;throw Error("Protocol not supported, got: "+JSON.stringify(e))}_fetch({url:r,offset:e,size:t},s){return e!==void 0&&t!==void 0&&(s={...s,headers:{...s.headers,Range:`bytes=${e}-${e+t-1}`}}),fetch(this._url(r),s)}async getItem(r,e={}){const t=this.ref.get(r);if(!t)throw new R(r);if(typeof t=="string")return t.startsWith("base64:")?M(t.slice(7)).buffer:N.encode(t).buffer;const[s,f,u]=t,a=s!=null?s:this.target;if(!a)throw Error(`No url for key ${r}, and no target url provided.`);const i=await this._fetch({url:a,offset:f,size:u},e);if(i.status===200||i.status===206)return i.arrayBuffer();throw new Error(`Request unsuccessful for key ${r}. Response status: ${i.status}.`)}async containsItem(r){return this.ref.has(r)}async keys(){return[...this.ref.keys()]}setItem(r,e){throw Error("FileReferenceStore.setItem is not implemented.")}deleteItem(r){throw Error("FileReferenceStore.deleteItem is not implemented.")}}const M=(()=>{for(var n=new Uint8Array(128),r=0;r<64;r++)n[r<26?r+65:r<52?r+71:r<62?r-4:r*4-205]=r;return e=>{for(var t=e.length,s=new Uint8Array((t-(e[t-1]=="=")-(e[t-2]=="="))*3/4|0),f=0,u=0;f<t;){var a=n[e.charCodeAt(f++)],i=n[e.charCodeAt(f++)],o=n[e.charCodeAt(f++)],c=n[e.charCodeAt(f++)];s[u++]=a<<2|i>>4,s[u++]=i<<4|o>>2,s[u++]=o<<6|c}return s}})(),N=new TextEncoder;export{y as ReferenceStore,O as parse};
